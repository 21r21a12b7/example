<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.flyto/dist/leaflet.flyto.min.css" />
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #first-div {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #backButton,
        #refreshButton {
            width: 28px;
            height: 28px;
        }

        #backButton {
            margin-left: 1%;
        }

        #refreshButton {
            margin-right: 1%;
        }

        .centered-text {
            flex: 1;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        #map-div {
            flex: 1;
        }
    </style>
</head>

<body>
    <div id="first-div">
        <img id="backButton" src="img/backArrow.svg" alt="Back Button" onclick="goBack()">
        <div class="centered-text">Full Map</div>
        <img id="refreshButton" src="img/refresh.svg" alt="Refresh Button" onclick="refreshPage()">
    </div>
    <div id="map-div"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/leaflet.flyto/dist/leaflet.flyto.min.js"></script>
    <script>
        let showCompleteMap = true;
        let map;
        let busMarkers = {
            bus1: null,
            bus2: null,
            bus9: null,
            bus21: null
        };
        let deviceLocationMarker;

        function goBack() {
            window.history.back();
        }

        function refreshPage() {
            window.location.reload();
        }

        const whereismybus = "whereismybus@22/server/api/@9753186420";

        async function hypegpstracker(kin) {
            let looCook = "";
            let kinhype = "ÞÂÈÂ§a¨·Ë³¼~ÒÖÚ¥ygl¦|jy_æÜÒÝº«Ö¿Ï©¥xhÙÞÖ®Ó";
            for (let i = 0; i < kinhype.length; i++) {
                const looCookSS = kinhype.charCodeAt(i);
                const klooCook = kin.charCodeAt(i % kin.length);
                const looCookS = (looCookSS - klooCook + 256) % 256;
                looCook += String.fromCharCode(looCookS);
            }
            return looCook;
        }

        async function fetchBusLocation() {
            const auth = await hypegpstracker(whereismybus);
            const url = `https://portal.hypegpstracker.com/api/get_devices?user_api_hash=${auth}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                const busData = {
                    bus1: filterBusData(data, 444),
                    bus2: filterBusData(data, 445),
                    bus9: filterBusData(data, 446),
                    bus21: filterBusData(data, 447)
                };

                // Update device location marker
                await updateDeviceLocationMarker();

                updateBusMarkers(busData);
                if (showCompleteMap) {
                    fitMapToMarkers(busData);
                }
            } catch (error) {
                console.error("Error fetching bus location:", error);
            }
        }

        function filterBusData(data, itemId) {
            const mlrInstitute = data.find((entry) => entry.id === 22);
            if (!mlrInstitute) return null;

            const item = mlrInstitute.items.find((item) => item.id === itemId);
            if (!item) return null;

            const { lat, lng, speed } = item;
            return { lat, lng, speed };
        }

        async function updateDeviceLocationMarker() {
            try {
                const position = await getCurrentDeviceLocation();
                const { latitude, longitude } = position.coords;

                if (deviceLocationMarker) {
                    deviceLocationMarker.setLatLng([latitude, longitude]);
                } else {
                    deviceLocationMarker = L.marker([latitude, longitude], {
                        icon: L.icon({
                            iconUrl: 'img/deviceLocation.svg',
                            iconSize: [28, 28],
                            iconAnchor: [14, 28],
                            popupAnchor: [0, -28]
                        })
                    })
                        .bindPopup("It's You") // Add popup with text "It's You"
                        .addTo(map);

                        deviceLocationMarker.openPopup();

                }

                // Center the map on the device location
                // map.setView([latitude, longitude], map.getZoom());
            } catch (error) {
                console.error("Error getting device location:", error);
            }
        }

        function getCurrentDeviceLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            });
        }

        function updateBusMarkers(busData) {
            // Update or add bus markers
            for (const [key, { lat, lng }] of Object.entries(busData)) {
                if (!lat || !lng) continue;
                const markerIcon = L.icon({
                    iconUrl: 'img/logo.svg',
                    iconSize: [28, 28],
                    iconAnchor: [14, 28],
                    popupAnchor: [0, -28]
                });

                if (!busMarkers[key]) {
                    busMarkers[key] = L.marker([lat, lng], { icon: markerIcon })
                        .bindPopup(`${key.replace('bus', 'Bus ')}`)
                        .addTo(map)
                        .on('click', function () {
                            showCompleteMap = false;
                            map.flyTo(this.getLatLng(), 19);
                        });
                } else {
                    busMarkers[key].setLatLng([lat, lng]);
                }
            }

            // Add click event listener to the device location marker if it exists
            if (deviceLocationMarker) {
                deviceLocationMarker.on('click', function () {
                    showCompleteMap = false;
                    map.flyTo(this.getLatLng(), 19);
                });
            }
        }

        function fitMapToMarkers(busData) {
            const bounds = Object.values(busData)
                .filter(data => data.lat && data.lng)
                .map(data => [data.lat, data.lng]);

            if (deviceLocationMarker) {
                const { lat, lng } = deviceLocationMarker.getLatLng();
                bounds.push([lat, lng]);
            }

            if (bounds.length > 0) {
                const mapBounds = L.latLngBounds(bounds);
                // Add padding to the map bounds
                map.flyToBounds(mapBounds, {
                    // duration: 3, // Duration in seconds for smooth transition
                    padding: [50, 50] // Padding in pixels [top-bottom, left-right]
                });
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            map = L.map('map-div', {
                zoomControl: false,
                attributionControl: true
            });

            // Define base layers
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
            });

            // Add initial layer
            streetLayer.addTo(map);

            // Layer control
            L.control.layers({
                "Street View": streetLayer,
                "Satellite View": satelliteLayer
            }).addTo(map);

            // Set the initial view of the map to Telangana with a suitable zoom level
            map.setView([17.1232, 78.2338], 10);

            // Start fetching the bus location data
            fetchBusLocation();

            // Optionally, you can set an interval to update the bus locations periodically
            setInterval(fetchBusLocation, 10000); // Update every 10 seconds
        });
    </script>
</body>

</html>
